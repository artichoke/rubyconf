<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Artichoke is a Ruby Made with Rust 💎🦀</title><link href="/rubyconf/presentation.af9a2e23f367d7a6a025.css" rel="stylesheet"></head><body><div class="reveal"><div class="slides"><section data-markdown><textarea data-template>
## Artichoke is a Ruby Made with Rust

💎🦀🚀

[https://artichoke.github.io/rubyconf/2019](https://artichoke.github.io/rubyconf/2019)
 </textarea></section><section><h3>Why Build a Ruby? 🏗💎</h3><iframe frameborder="0" scrolling="no" marginheight="0" marginwidth="0" width="544.6800000000001" height="306" type="text/html" src="https://www.youtube.com/embed/qybUFnY7Y8w?autoplay=1&fs=0&iv_load_policy=3&showinfo=0&rel=0&cc_load_policy=0&start=0&end=0&mute=1"></iframe></section><section data-markdown><textarea data-template>
### Goals

- Build for WebAssembly targets 🎯
- Execute Ruby in untrusted environments 🕵️‍♀️
- Distribute Ruby apps as a single binaries 🧳
 </textarea></section><section><h3>Build for WebAssembly Targets</h3><div class="fig-container" data-file="https://artichoke.run/?embed#%23%20frozen_string_literal%3A%20true%0A%0Arequire%20'strscan'%0A%0Ascanner%20%3D%20StringScanner.new(RUBY_DESCRIPTION)%0Ascanner.scan_until(%2F%5C%5B(%3F%3Cplatform%3E.%2B)%5C%5D%2F)%0A%0Aplatform%20%3D%20scanner%5B%3Aplatform%5D%0Aputs%20%22%F0%9F%91%8B%20from%20%23%7Bplatform%7D%20%F0%9F%8E%AF%22" data-style="height: 400px"></div></section><section data-markdown><textarea data-template>
### WebAssembly

> WebAssembly (abbreviated Wasm) is a binary instruction format for a
> stack-based virtual machine. Wasm is designed as a portable target for
> compilation of high-level languages like C/C++/Rust, enabling deployment on
> the web for client and server applications.

<cite><a href="https://webassembly.org/">WebAssembly.org</a></cite>
 </textarea></section><section data-markdown><textarea data-template>
            ### WebAssembly

- Successor to asm.js 👑
- Machine code for browsers 📖
- Multi-platform (not only browsers) 👻👽👾🤖
 </textarea></section><section data-markdown><textarea data-template>
            ### WebAssembly

- Sandboxed by default 🏖
- Runtime-mediated system access 🛑
- Safe memory accesses ✅
 </textarea></section><section data-markdown><textarea data-template>
            ### WebAssembly

⬇️

### Execute Ruby in Untrusted Environments
 </textarea></section><section data-markdown><textarea data-template>
            ### Untrusted `ENV` Access

- Multiple backends: system 🖥, in-memory 🎟
- Injectable at compile time 💉
 </textarea></section><section><h3>Untrusted <code>ENV</code> Access</h3><div class="fig-container" data-file="https://artichoke.run/?embed#%23%20frozen_string_literal%3A%20true%0A%0Aputs%20ENV.size%0AENV.to_h" data-style="height: 400px"></div></section><section data-markdown><textarea data-template>
#### Core Classes and Modules

```ruby
ary = Array.new(1024, 'Artichoke Ruby')
h = Hash[:conference, 'RubyConf', :year, 2019]
fixture = File.readlines(
  'artichoke-frontend/ruby/fixtures/learnxinyminutes.txt'
)
```
 </textarea></section><section data-markdown><textarea data-template>
#### Standard Library

```ruby
require 'forwardable'
require 'json'

class Properties
  extend Forwardable
  def_delegators :@properties, :[], :[]=, :to_json
  def initialize
    @properties = {}
  end
end
artichoke = Properties.new
artichoke[:lang] = 'Ruby'
artichoke[:impl] = 'Artichoke'

puts JSON.pretty_generate(artichoke)
```
 </textarea></section><section data-markdown><textarea data-template>
#### Behavior — ruby/spec

```ruby
describe "Regexp#named_captures" do
  it "returns a Hash" do
    /foo/.named_captures.should be_an_instance_of(Hash)
  end

  it "returns an empty Hash when there are no capture groups" do
    /foo/.named_captures.should == {}
  end

  it "sets the keys of the Hash to the names of the capture groups" do
    rex = /this (?<is>is) [aA] (?<pat>pate?rn)/
    rex.named_captures.keys.should == ['is','pat']
  end
end
```
</pat></is></textarea></section><section data-markdown><textarea data-template>
#### MRI C API

```c
mNokogiri         = rb_define_module("Nokogiri");
mNokogiriXml      = rb_define_module_under(mNokogiri, "XML");
mNokogiriHtml     = rb_define_module_under(mNokogiri, "HTML");
mNokogiriXslt     = rb_define_module_under(mNokogiri, "XSLT");
mNokogiriXmlSax   = rb_define_module_under(mNokogiriXml, "SAX");
mNokogiriHtmlSax  = rb_define_module_under(mNokogiriHtml, "SAX");
```
</textarea></section><section><h3>Artichoke is Ruby</h3><p align="center"><img alt="Artichoke is Ruby" src="/rubyconf/logo-red.svg"></p></section><section data-markdown><textarea data-template>
### Where Can We Take Ruby?

🚀🛰💫☄️
</textarea></section><section data-markdown><textarea data-template>
#### Single Binary Distribution

- Embed Standard Library into the `ruby` binary 🧳
- _Statically linked_ Ruby app bundles ⛓🎁
- Run Ruby in a `FROM scratch` Docker container 🐳
</textarea></section><section data-markdown><textarea data-template>
#### Optional Standard Library

- Control API surface area 🎛
- Faster startup 🍳
- Smaller deploy artifacts 🔬
</textarea></section><section data-markdown><textarea data-template>
#### Thread-Safe by Default

- Automatic synchronization across `Thread`s 🐢🐇
- Transparent hoisting from local to shared heap 🥾🐾
- An `Array` is a `Queue` 🍒
</textarea></section><section data-markdown><textarea data-template>
#### Optional Multi-Threading

- Disable synchronization at `ruby` compile time 🔩
- Avoid perf hit, code bloat, and impl complexity ☣️
- Adapt Ruby to the ecosystem, e.g. 🦄 is prefork
</textarea></section><section data-markdown><textarea data-template>
#### Multiple Implementations of Core Classes

- DFA-based `Regexp` engines 🐯
- Sparse, repeated, and aggregate `Array`s ⚡️
- Small vec optimized `Hash` 🐣
- Sandboxed `IO` ⛱
- In-memory filesystems 📂
- Virtualized `ENV` 🙈🙊
</textarea></section><section data-markdown><textarea data-template>
#### Increased Performance

- SIMD vectorization ↗️💨
- Aggregate data structures 🎷🎺 ➕ 🎸🎻
- Specialization 👩‍⚕️👩‍🍳👩‍🏫
- Const evaluation 🧮
- Stuctural sharing, clone on write 🤝
- Native JIT compilation 🛠
- Event-loop powered multi-threading 🧵
- Function and block-local arenas 🏟
- Dynamically initialized standard library 🧨
</textarea></section><section data-markdown><textarea data-template>
### Why Rust?

🤩👩‍🏭
</textarea></section><section data-markdown><textarea data-template>
#### Excellent FFI Support

- Enable implementing the entire MRI C API 💪
- Aim to be a drop-in replacement for MRI when executing C extensions 🤸‍♀️
</textarea></section><section data-markdown><textarea data-template>
#### `std` and Crate Ecosystem

- Very easy to use and build dependencies 🐎
- Crates are high performance and high quality 🏅
- Rust development is fast and produces fast code 🤺
</textarea></section><section data-markdown><textarea data-template>
#### WebAssembly

- Rust natively builds to Wasm 🕸
- Ruby in the browser 🌐
- Ruby in untrusted, sandboxed environments 🕵️‍♀️
</textarea></section><section><h2>Benchmarks</h2><blockquote class="twitter-tweet tw-align-center"><p lang="en" dir="ltr">Micro benches are useless because they are too small for anyone to sit on</p>&mdash; Aaron Patterson (@tenderlove) <a href="https://twitter.com/tenderlove/status/1189265228497854464?ref_src=twsrc%5Etfw">October 29, 2019</a></blockquote><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><div style="display:flex;flex-direction:row"><div style="font-size:1em;margin:auto"><a href="https://rubybench.org/ruby/ruby/releases">RubyBench 🏋️‍♀️</a></div></div></section><section data-markdown><textarea data-template>
            ### `Array#shift`

```ruby
[10_000, 1_000_000, 100_000_000].each do |n|
  ary = Array.new(n, 0)
  ary.shift

  (0..4).each do |i|
    ary = Array.new(n, 0)
    ary.shift(i)
  end
end
```
</textarea></section><section><h3><code>Array#shift</code></h3><div class="stat-container"><div class="stat-box"><div class="stat-box-type">MRI</div><div class="stat-box-number">0.3</div><div class="stat-box-units">iterations / second</div></div><div class="divider"></div><div class="stat-box"><div class="stat-box-type stat-box-win">Artichoke</div><div class="stat-box-number">100</div><div class="stat-box-units">iterations / second</div></div></div></section><section><h3><code>Array#shift</code></h3><div class="stat-container"><div class="stat-box"><div class="stat-box-type">MRI</div><div class="stat-box-number">3109</div><div class="stat-box-units">MB / iteration</div></div><div class="divider"></div><div class="stat-box"><div class="stat-box-type stat-box-win">Artichoke</div><div class="stat-box-number">3</div><div class="stat-box-units">MB / iteration</div></div></div></section><section data-markdown><textarea data-template>
            ### `String#scan(str)`

```ruby
str = Array.new(10_000, 'abc').join(',')
1_000.times { str.scan('abc') }
```
</textarea></section><section><h3><code>String#scan(str)</code></h3><div class="stat-container"><div class="stat-box"><div class="stat-box-type">MRI</div><div class="stat-box-number">0.74</div><div class="stat-box-units">iterations / second</div></div><div class="divider"></div><div class="stat-box"><div class="stat-box-type stat-box-win">Artichoke</div><div class="stat-box-number">0.79</div><div class="stat-box-units">iterations / second</div></div></div></section><section><h3><code>String#scan(str)</code></h3><div class="stat-container"><div class="stat-box"><div class="stat-box-type stat-box-win">MRI</div><div class="stat-box-number">14</div><div class="stat-box-units">MB / iteration</div></div><div class="divider"></div><div class="stat-box"><div class="stat-box-type">Artichoke</div><div class="stat-box-number">34</div><div class="stat-box-units">MB / iteration</div></div></div></section><section><h3><code>String#scan</code></h3><div class="fig-container" style="overflow:hidden" data-file="/rubyconf/2e55bb8897de4324241207d3aad535a9.txt" data-style="height: 500px; width: 500px"></div></section><section data-markdown><textarea data-template>
            ### `String#scan`

6.8MB text corpus with Unicode contents 📚

```ruby
raise unless $fixture.scan('http://').length == 3539
raise unless $fixture.scan('https://').length == 1865
raise unless $fixture.scan('表达式').length == 120
raise unless $fixture.scan("\r\n").empty?
```
</textarea></section><section><h3><code>String#scan</code></h3><div class="stat-container"><div class="stat-box"><div class="stat-box-type">MRI</div><div class="stat-box-number">9.4</div><div class="stat-box-units">iterations / second</div></div><div class="divider"></div><div class="stat-box"><div class="stat-box-type stat-box-win">Artichoke</div><div class="stat-box-number">15.0</div><div class="stat-box-units">iterations / second</div></div></div></section><section><h3><code>String#scan</code></h3><div class="stat-container"><div class="stat-box"><div class="stat-box-type stat-box-win">MRI</div><div class="stat-box-number">23</div><div class="stat-box-units">MB / iteration</div></div><div class="divider"></div><div class="stat-box"><div class="stat-box-type">Artichoke</div><div class="stat-box-number">36</div><div class="stat-box-units">MB / iteration</div></div></div></section><section data-markdown><textarea data-template>
            ### Sparse Array Allocation

```ruby
a = []
a[1_000_000_000_000_000] = 'quadrillion'

a.concat((0..1000).to_a)

100.times do |i|
  a.unshift(i)
end

b = a.reverse

b[500_000, 500_000] = [Object.new, /Array/, 100.0]

puts a.length # => 1000000000001102
puts b.length # => 999999999501105
```
</textarea></section><section><h3>Sparse Array Allocation</h3><div class="stat-container"><div class="stat-box"><div class="stat-box-type">MRI</div><div class="stat-box-text">failed to allocate memory (<code>NoMemoryError</code>)</div><div class="stat-box-units"></div></div><div class="divider"></div><div class="stat-box"><div class="stat-box-type stat-box-win">Artichoke</div><div class="stat-box-number">4</div><div class="stat-box-units">MB / iteration</div></div></div></section><section data-markdown><textarea data-template>
### Ruby in the Browser

[Artichoke Ruby Wasm Playground](https://artichoke.run)
</textarea></section><section><div class="fig-container" style="overflow:hidden" data-file="https://artichoke.run" data-style="height: 960px; width: 960px; margin-top: -64px;"></div></section></div></div><div id="hidden" style="display:none"><div id="header"><div class="header"><div class="header-tweet"><a href="https://twitter.com/intent/tweet?screen_name=artichokeruby&ref_src=twsrc%5Etfw" class="twitter-mention-button" data-size="large" data-show-count="false">Tweet to @artichokeruby</a><script src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></div><div></div><div class="header-logo"></div></div><div class="footer-logo"><img src="/rubyconf/logo.svg" height="125"></div></div></div><script type="text/javascript" src="/rubyconf/presentation.af9a2e23f367d7a6a025.bundle.js"></script></body></html>