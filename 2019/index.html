<!doctypehtml><html dir=ltr lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,viewport-fit=cover"name=viewport><title>RubyConf 2019: Artichoke is a Ruby Made with Rust 💎🦀</title><meta content="Artichoke 2019 RubyConf Talk"name=description><meta content="Ryan Lopopolo"name=author><link href=//platform.twitter.com rel=dns-prefetch><link href=//rubyconf2019.artichoke.run rel=dns-prefetch><link href=https://platform.twitter.com rel=preconnect><link href=//rubyconf2019.artichoke.run rel=preconnect><link href=/rubyconf/favicon-32x32.png rel=icon sizes=32x32><link href=/rubyconf/favicon-128x128.png rel=icon sizes=128x128><link href=/rubyconf/favicon-192x192.png rel=icon sizes=192x192><link rel="shortcut icon"href=/rubyconf/favicon-196x196.png sizes=196x196><link href=/rubyconf/favicon-152x152.png rel=apple-touch-icon sizes=152x152><link href=/rubyconf/favicon-180x180.png rel=apple-touch-icon sizes=180x180><link color=black href=/rubyconf/safari-pinned-tab.svg rel=mask-icon><meta content=#ffffff name=msapplication-tilecolor><meta content=/mstile-150x150.png name=msapplication-tileimage><link href=/rubyconf/site.webmanifest rel=manifest><link href=https://artichoke.github.io/rubyconf/2019/ rel=canonical><meta content=summary_large_image name=twitter:card><meta content=@artichokeruby name=twitter:site><meta content=@artichokeruby name=twitter:creator><meta content="Artichoke Ruby"name=twitter:title><meta content="RubyConf 2019: Artichoke is a Ruby made with Rust."name=twitter:description><meta content=/rubyconf/artichoke-social-logo.png name=twitter:image><meta content=https://artichoke.github.io/rubyconf/2019/ property=og:url><meta content=artichokeruby.org property=og:site_name><meta content="RubyConf 2019: Artichoke"property=og:title><meta content="RubyConf 2019: Artichoke is a Ruby made with Rust."property=og:description><meta content=website property=og:type><meta content=/rubyconf/artichoke-social-logo.png property=og:image><meta content=image/png property=og:image:type><meta content=1600 property=og:image:width><meta content=800 property=og:image:height><script crossorigin src=/rubyconf/assets/2019-e1f64235.js type=module></script><link crossorigin href=/rubyconf/assets/white-fd104f17.js rel=modulepreload><link href=/rubyconf/assets/white-306c9ef2.css rel=stylesheet><link href=/rubyconf/assets/index-2a447043.css rel=stylesheet></head><body><div class=reveal id=js-reveal-container><div class=slides><section><h2>Artichoke is a Ruby Made with Rust</h2><p>💎🦀🚀</p><p><a href=https://artichoke.github.io/rubyconf/2019>🎢 artichoke.github.io/rubyconf/2019</a><br><a href=https://artichoke.run>🎡 artichoke.run</a></p></section><section><h3>Artichoke Ruby</h3><iframe src="https://rubyconf2019.artichoke.run/?embed#%23%20frozen_string_literal%3A%20true%0A%0Arequire%20'forwardable'%0Arequire%20'json'%0A%0Aclass%20Properties%0A%20%20extend%20Forwardable%0A%20%20def_delegators%20%3A%40properties%2C%20%3A%5B%5D%2C%20%3A%5B%5D%3D%2C%20%3Ato_json%0A%0A%20%20def%20initialize(name)%0A%20%20%20%20%40name%20%3D%20name%0A%20%20%20%20%40properties%20%3D%20%7B%7D%0A%20%20end%0Aend%0A%0Aartichoke%20%3D%20Properties.new('Artichoke%20Ruby')%0Aartichoke%5B%3Alanguage%5D%20%3D%20'Ruby'%0Aartichoke%5B%3Aimplementation%5D%20%3D%20'Artichoke'%0Aartichoke%5B%3Atarget%5D%20%3D%20'wasm'%0Aartichoke%5B%3Aemoji%5D%20%3D%20'%F0%9F%92%8E'%0A%0Aserialized%20%3D%20JSON.pretty_generate(artichoke)%0A%0Aputs%20serialized%20if%20serialized%20%3D~%20%2F%F0%9F%92%8E%2F"class=playground></iframe></section><section><h3>Why Build a Ruby? 🏗💎</h3><iframe src="https://www.youtube.com/embed/qybUFnY7Y8w?autoplay=0&fs=0&iv_load_policy=3&showinfo=0&rel=0&cc_load_policy=0&start=0&end=0&mute=1"frameborder=0 height=306 marginheight=0 marginwidth=0 scrolling=no type=text/html width=544></iframe></section><section><h3>Contributing</h3><p><a href=https://github.com/artichoke> <img alt=GitHub class=github-logo src=/rubyconf/social/github-logo.svg> github.com/artichoke </a></p><p><a href=https://rubyconf2019.artichoke.run>🎡 artichoke.run</a></p><p><a title="Call for participation: Experience needed to fix: Easy / not much."class=IssueLabel href=https://github.com/artichoke/artichoke/labels/E-easy> E-easy </a> <a title="Call for participation: Help is requested to fix this issue."class=IssueLabel href=https://github.com/artichoke/artichoke/labels/E-help-wanted> E-help-wanted </a></p></section><section><h3>Goals</h3><ul><li>Build for WebAssembly 🎯</li><li>Execute untrusted code 🔦🔍</li><li>Package single-binary apps 🧳</li></ul></section><section><h4>WebAssembly</h4><ul><li>Sandboxed by default 🏖</li><li>Multi-platform 👻👽👾🤖</li><li>Ruby in the browser 🍭</li></ul></section><section><h4>Untrusted Code</h4><p>"Code execution as a service"<br>🎲🎰</p></section><section><h4>Why Execute Untrusted Code?</h4><ul><li><a href=https://developer.mozilla.org/en-US/docs/WebAssembly>Mozilla Firefox</a> 🔥🦊</li><li><a href=https://docs.godotengine.org/en/3.1/getting_started/step_by_step/scripting.html>Godot scripting</a> 🕹🎮</li><li><a href=https://github.com/Shopify/shopify-scripts>Shopify Scripts</a> 🛍🛒</li><li><a href=https://redis.io/commands/eval>Redis <code>EVAL</code></a> 🧱💈</li></ul></section><section><section><h4>Single Binary Apps</h4><p>Dead simple, hermetic deployments 🍱</p></section><section><h4>Single Binary Apps</h4><p>Apps are hard to package 📦<br>especially for the web 🐒</p></section><section><h4>Single Binary Apps</h4><ul><li>Ruby, stdlib, gems load shared objects ❗️</li><li>Stdlib, gems, apps load Ruby code 💔</li><li>Apps load Ruby code, config, and assets 💥</li></ul></section></section><section><h3>Goals</h3><ul><li>Build for WebAssembly 🎯</li><li>Execute untrusted code 🔦🔍</li><li>Package single-binary apps 🧳</li></ul></section><section><h3>Artichoke 💎❤️🦀 Rust</h3></section><section><section><h4>WebAssembly Compilation</h4><p>Build on WebAssembly targets with a<br>native compiler toolchain 🛠</p></section><section><h4>Building WebAssembly</h4><pre><code class="hljs artichoke-highlight language-shell">rustup add target wasm32-unknown-emscripten
cargo build --release --target wasm32-unknown-emscripten
</code></pre></section></section><section><h4>Deep Web Integration</h4><iframe src="https://rubyconf2019.artichoke.run/?embed#%23%20frozen_string_literal%3A%20true%0A%0A%3C%3CUSAGE%0AThis%20program%20is%20a%20quine%20built%20using%0AArtichoke%20Ruby%20and%20a%20gem%20based%20on%20stdweb.%0AUSAGE%0A%0Arequire%20'uri'%0Arequire%20'artichoke%2Fweb'%0A%0Alocation%20%3D%20Artichoke%3A%3AWeb%3A%3AWindow.location%0Acontents%20%3D%20location.hash%5B1..-1%5D%0Aputs%20URI.decode(contents)"class=playground></iframe></section><section><section><h4>Static Linking</h4><p>Drop a single binary in <code>FROM scratch</code> Docker container and run a full Rails app 💎🐳</p></section><section><h4>Static Linking</h4><p>Statically linked dependencies enable<br>single binary app distributions 📻</p></section><section><h4>Static Linking</h4><p>Statically linked libc enables<br>single binary app distributions 🥔</p><hr style=width:50%><p><code>x86_64-unknown-linux-musl</code></p></section></section><section><h3>From Rust to Ruby</h3><p>🦀 ➡️ 💎</p></section><section><h3>Ruby Core</h3><pre><code class="hljs artichoke-highlight language-ruby"><span class="hljs-variable constant_">ENV</span>[<span class=hljs-string>'DRY_RUN'</span>] = <span class=hljs-string>'0'</span>
ary = <span class="hljs-title class_">Array</span>.new(<span class=hljs-number>1024</span>, <span class=hljs-string>'Artichoke Ruby'</span>)
fixture = <span class="hljs-title class_">File</span>.read(
  <span class=hljs-string>'artichoke-frontend/ruby/fixtures/learnxinyminutes.txt'</span>
)
/function/.match(fixture)
</code></pre></section><section><h3>Ruby Core</h3><ul><li>Multiple implementations 😺😸😻</li><li>Configurable at compile time 🏘</li></ul></section><section><section><h4>Untrusted <code>ENV</code> Access</h4><iframe src="https://rubyconf2019.artichoke.run/?embed#%23%20frozen_string_literal%3A%20true%0A%0Aputs%20%22%23%7BENV.size%7D%20keys%20in%20%23%7BENV%7D%22%0Aputs%20%22ENV%20%3D%20%23%7BENV.to_h%7D%22%0A%0AENV%5B'CONFERENCE'%5D%20%3D%20'RubyConf'%0A%0Aputs%20%22ENV%20%3D%20%23%7BENV.to_h%7D%22"class=playground></iframe></section><section><h4><code>ENV</code></h4><ul><li>System backend ↔️ OS 🖥</li><li>In-memory backend ↔️ <code>HashMap</code> 🎟</li></ul></section><section><h4>In-Memory <code>ENV</code></h4><p>Build on WebAssembly targets that<br>do not have a system environ 🔧</p></section><section><h4>In-Memory <code>ENV</code></h4><p>Run untrusted code by<br>restricting system access ⛓</p></section></section><section><section><h4>Capturable <code>IO</code></h4><iframe src="https://rubyconf2019.artichoke.run/?embed#%23%20frozen_string_literal%3A%20true%0A%0Awarn%20%22That's%20no%20moon.%22%0A%0A(1..5).each%20do%20%7Cpilot%7C%0A%20%20print%20%22Red%20%23%7Bpilot%7D%20standing%20by%20...%22%2C%20%22%5Cn%22%0Aend%0A%0Aputs%20''%2C%20'Lock%20S-foils%20in%20attack%20position.'"class=playground></iframe></section><section><h4><code>IO</code></h4><ul><li>Capturable <code>$stdout</code> and <code>$stderr</code> 🧤</li><li>Optional <code>IO#popen</code> 🚪</li><li>Optional <code>Kernel#open("|date")</code> 📅</li></ul></section><section><h4>Capturable <code>IO</code></h4><p>Build on WebAssembly targets that<br>do not have file descriptors 🔧</p></section><section><h4>Disabled <code>IO</code> pipes</h4><p>Run untrusted code by disabling<br>subprocess capabilities ⛓</p></section></section><section><section><h4>Virtual <code>Kernel#require</code></h4><iframe src="https://rubyconf2019.artichoke.run/?embed#%23%20frozen_string_literal%3A%20true%0A%0Arequire%20'json'%0A%0Ajson%20%3D%20%7B%20backend%3A%20'memory'%20%7D.to_json%0A%0Aputs%20json"class=playground></iframe></section><section><h4><code>File</code> Access</h4><ul><li>System backend ↔️ OS 🗄📁</li><li>In-memory backend ↔️ <code>HashMap</code> 🗃🗂</li></ul></section></section><section><section><h4>Pure Rust <code>Regexp</code></h4><iframe class=playground src=https://rubyconf2019.artichoke.run/?embed#%23%20frozen_string_literal%3A%20true%0A%0Ahaystack%20%3D%20%3C%3C-HAYSTACK%0A%20%20%5B%20ruby_koans%20%5D%20%24%20ruby%20path_to_enlightenment.rb%0A%20%20(in%20%2FUsers%2Fperson%2Fdev%2Fruby_koans)%0A%20%20cd%20koans%0A%0A%20%20Thinking%20AboutAsserts%0A%20%20test_assert_truth%20has%20damaged%20your%20karma.%0A%0A%20%20You%20have%20not%20yet%20reached%20enlightenment%20...%0A%20%20%3Cfalse%3E%20is%20not%20true.%0AHAYSTACK%0A%0Amatch%20%3D%20%2Fruby%20(%5Ba-zA-Z0-9_%5D%2B%5C.rb)%2F.match(haystack)%0A%0Aputs%20%22To%20walk%20the%20path%2C%20run%3A%22%2C%20%22%24%20ruby%20%23%7Bmatch%5B1%5D%7D%22></iframe></section><section><h4><code>Regexp</code></h4><ul><li>Pure Rust engine for WebAssembly 💧</li><li>Oniguruma engine for compatibility 🚗</li></ul></section></section><section><h3>From Core to Fast</h3><p>🏎💨 🏎🏎</p><p><small>Benchmarks run on AWS <code>c5.2xlarge</code> 🖥 🖥</small></p></section><section><section><h3><code>String#scan</code></h3><p><code>String</code> pattern over 6.8MB of Unicode text 📚</p><pre><code class="hljs artichoke-highlight language-ruby"><span class=hljs-keyword>raise</span> <span class=hljs-keyword>unless</span> <span class=hljs-variable>$fixture</span>.scan(<span class=hljs-string>'http://'</span>).length == <span class=hljs-number>3539</span>
<span class=hljs-keyword>raise</span> <span class=hljs-keyword>unless</span> <span class=hljs-variable>$fixture</span>.scan(<span class=hljs-string>'https://'</span>).length == <span class=hljs-number>1865</span>
<span class=hljs-keyword>raise</span> <span class=hljs-keyword>unless</span> <span class=hljs-variable>$fixture</span>.scan(<span class=hljs-string>'表达式'</span>).length == <span class=hljs-number>120</span>
<span class=hljs-keyword>raise</span> <span class=hljs-keyword>unless</span> <span class=hljs-variable>$fixture</span>.scan(<span class=hljs-string>"\r\n"</span>).empty?
</code></pre></section><section><h3><code>String#scan</code></h3><iframe class=playground src=/rubyconf/learnxinyminutes-truncated.txt></iframe></section></section><section><h3><code>String#scan</code></h3><div class=stat-container><div class="stat-box stat-box-win"><div class=stat-box-type>Artichoke</div><div class=stat-box-number>66</div><div class=stat-box-units>ms / iteration</div></div><div class=divider></div><div class=stat-box><div class=stat-box-type>MRI</div><div class=stat-box-number>82</div><div class=stat-box-units>ms / iteration</div></div></div></section><section><section><h3><code>String#scan</code></h3><p><code>Regexp</code> pattern over 6.8MB of Unicode text 📚</p><pre><code class="hljs artichoke-highlight language-ruby"><span class=hljs-keyword>raise</span> <span class=hljs-keyword>unless</span> <span class=hljs-variable>$fixture</span>.scan(<span class=hljs-regexp>%r{https?://}</span>).length == <span class=hljs-number>3539</span>+<span class=hljs-number>1865</span>
<span class=hljs-keyword>raise</span> <span class=hljs-keyword>unless</span> <span class=hljs-variable>$fixture</span>.scan(<span class=hljs-regexp>/表达式/</span>).length == <span class=hljs-number>120</span>
<span class=hljs-keyword>raise</span> <span class=hljs-keyword>unless</span> <span class=hljs-variable>$fixture</span>.scan(<span class=hljs-regexp>/\r\n/</span>).empty?
</code></pre></section><section><h3><code>String#scan</code></h3><iframe class=playground src=/rubyconf/learnxinyminutes-truncated.txt></iframe></section></section><section><h3><code>String#scan</code></h3><div class=stat-container><div class="stat-box stat-box-win"><div class=stat-box-type>Artichoke</div><div class=stat-box-number>48</div><div class=stat-box-units>ms / iteration</div></div><div class=divider></div><div class=stat-box><div class=stat-box-type>MRI</div><div class=stat-box-number>89</div><div class=stat-box-units>ms / iteration</div></div></div></section><section><h3>Sparse Array Allocation</h3><pre><code class="hljs artichoke-highlight language-ruby">a = []
a[<span class=hljs-number>1_000_000_000_000_000</span>] = <span class=hljs-string>'quadrillion'</span>
a.concat((<span class=hljs-number>0</span>..<span class=hljs-number>1000</span>).to_a)

<span class=hljs-number>100</span>.times <span class=hljs-keyword>do</span> |<span class=hljs-params>i</span>|
  a.unshift(i)
<span class=hljs-keyword>end</span>

b = a.reverse
b[<span class=hljs-number>123_456_789</span>, <span class=hljs-number>500_000</span>] = [<span class="hljs-title class_">Object</span>.new, <span class=hljs-regexp>/Array/</span>, <span class=hljs-number>100.0</span>]

puts a.length <span class=hljs-comment># => 1000000000001102</span>
puts b.length <span class=hljs-comment># => 999999999501105</span>
</code></pre></section><section><h3>Sparse Array Allocation</h3><div class=stat-container><div class="stat-box stat-box-win"><div class=stat-box-type>Artichoke</div><div class=stat-box-number>7</div><div class=stat-box-units>MB / iteration</div></div><div class=divider></div><div class=stat-box><div class=stat-box-type>MRI</div><div class=stat-box-text>failed to allocate memory (<code>NoMemoryError</code>)</div><div class=stat-box-units></div></div></div></section><section><h3>Upcoming Core Work</h3><ul><li><code>Hash</code> with small vec backend 🍳</li><li><code>Range</code> and <code>Range</code>-based <code>Array</code> 🦉</li><li><code>File</code> with in-memory and OS backends 🧩</li></ul></section><section><h3>Contributing</h3><p><a href=https://github.com/artichoke> <img alt=GitHub class=github-logo src=/rubyconf/social/github-logo.svg> github.com/artichoke </a></p><p><a href=https://rubyconf2019.artichoke.run>🎡 artichoke.run</a></p><p><a title="Call for participation: Experience needed to fix: Easy / not much."class=IssueLabel href=https://github.com/artichoke/artichoke/labels/E-easy> E-easy </a> <a title="Call for participation: Help is requested to fix this issue."class=IssueLabel href=https://github.com/artichoke/artichoke/labels/E-help-wanted> E-help-wanted </a></p></section></div></div><div class=artichoke-footer-logo id=js-artichoke-chrome><div class=header><div class=header-tweet><a href="https://twitter.com/intent/tweet?screen_name=artichokeruby&ref_src=twsrc%5Etfw"class=twitter-mention-button data-show-count=false data-size=large> Tweet to @artichokeruby </a></div><div></div><div class=header-logo></div></div><div class=footer-logo><a alt="Artichoke Ruby"href=https://github.com/artichoke/artichoke> <img src=/rubyconf/artichoke-logo.svg> </a></div></div></body></html>