<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta property="og:title" content="Artichoke is a Ruby Made with Rust"><meta property="og:site_name" content="artichoke.github.io"><meta property="og:url" content="https://artichoke.github.io/rubyconf/2019/"><meta property="og:description" content="Presentation from RubyConf 2019"><meta property="og:type" content="website"><meta property="og:image" content="https://artichoke.github.io/rubyconf/artichoke-logo.png"><title>Artichoke is a Ruby Made with Rust ğŸ’ğŸ¦€</title><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#b91d47"><meta name="msapplication-TileColor" content="#b91d47"><meta name="theme-color" content="#ffffff"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-158900370-3"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-158900370-3")</script><link href="/rubyconf/deck.2019.f9e71337231f2d5aaa1f.css" rel="stylesheet"></head><body><div class="reveal"><div class="slides"><section data-markdown><textarea data-template>
            ## Artichoke is a Ruby Made with Rust

ğŸ’ğŸ¦€ğŸš€

[ğŸ¢ artichoke.github.io/rubyconf/2019](https://artichoke.github.io/rubyconf/2019)  
[ğŸ¡ artichoke.run](https://artichoke.run)

          </textarea></section><section><h3>Artichoke Ruby</h3><iframe class="playground" src="https://artichoke.run/?embed#%23%20frozen_string_literal%3A%20true%0A%0Arequire%20'forwardable'%0Arequire%20'json'%0A%0Aclass%20Properties%0A%20%20extend%20Forwardable%0A%20%20def_delegators%20%3A%40properties%2C%20%3A%5B%5D%2C%20%3A%5B%5D%3D%2C%20%3Ato_json%0A%0A%20%20def%20initialize(name)%0A%20%20%20%20%40name%20%3D%20name%0A%20%20%20%20%40properties%20%3D%20%7B%7D%0A%20%20end%0Aend%0A%0Aartichoke%20%3D%20Properties.new('Artichoke%20Ruby')%0Aartichoke%5B%3Alanguage%5D%20%3D%20'Ruby'%0Aartichoke%5B%3Aimplementation%5D%20%3D%20'Artichoke'%0Aartichoke%5B%3Atarget%5D%20%3D%20'wasm'%0Aartichoke%5B%3Aemoji%5D%20%3D%20'%F0%9F%92%8E'%0A%0Aserialized%20%3D%20JSON.pretty_generate(artichoke)%0A%0Aputs%20serialized%20if%20serialized%20%3D~%20%2F%F0%9F%92%8E%2F"></iframe></section><section><h3>Why Build a Ruby? ğŸ—ğŸ’</h3><iframe frameborder="0" scrolling="no" marginheight="0" marginwidth="0" width="544" height="306" type="text/html" src="https://www.youtube.com/embed/qybUFnY7Y8w?autoplay=0&fs=0&iv_load_policy=3&showinfo=0&rel=0&cc_load_policy=0&start=0&end=0&mute=1"></iframe></section><section><h3>Contributing</h3><p><a href="https://github.com/artichoke"><img class="github-logo" src="[object Module]" alt="GitHub"> github.com/artichoke</a></p><p><a href="https://artichoke.run">ğŸ¡ artichoke.run</a></p><p><a class="IssueLabel" style="background-color:#02e10c;color:#000" title="Call for participation: Experience needed to fix: Easy / not much." href="https://github.com/artichoke/artichoke/labels/E-easy">E-easy </a><a class="IssueLabel" style="background-color:#02e10c;color:#000" title="Call for participation: Help is requested to fix this issue." href="https://github.com/artichoke/artichoke/labels/E-help-wanted">E-help-wanted</a></p></section><section data-markdown><textarea data-template>
            ### Goals

- Build for WebAssembly ğŸ¯
- Execute untrusted code ğŸ”¦ğŸ”
- Package single-binary apps ğŸ§³

          </textarea></section><section data-markdown><textarea data-template>
            #### WebAssembly

- Sandboxed by default ğŸ–
- Multi-platform ğŸ‘»ğŸ‘½ğŸ‘¾ğŸ¤–
- Ruby in the browser ğŸ­

          </textarea></section><section data-markdown><textarea data-template>
            #### Untrusted Code

"Code execution as a service"  
ğŸ²ğŸ°

          </textarea></section><section data-markdown><textarea data-template>
            #### Why Execute Untrusted Code?

- [Mozilla Firefox](https://developer.mozilla.org/en-US/docs/WebAssembly) ğŸ”¥ğŸ¦Š
- [Godot scripting](https://docs.godotengine.org/en/3.1/getting_started/step_by_step/scripting.html)
  ğŸ•¹ğŸ®
- [Shopify Scripts](https://github.com/Shopify/shopify-scripts) ğŸ›ğŸ›’
- [Redis `EVAL`](https://redis.io/commands/eval) ğŸ§±ğŸ’ˆ

          </textarea></section><section><section data-markdown><textarea data-template>
            #### Single Binary Apps

Dead simple, hermetic deployments ğŸ±

          </textarea></section><section data-markdown><textarea data-template>
            #### Single Binary Apps

Apps are hard to package ğŸ“¦  
especially for the web ğŸ’

          </textarea></section><section data-markdown><textarea data-template>
            #### Single Binary Apps

- Ruby, stdlib, gems load shared objects â—ï¸
- Stdlib, gems, apps load Ruby code ğŸ’”
- Apps load Ruby code, config, and assets ğŸ’¥

          </textarea></section></section><section data-markdown><textarea data-template>
            ### Goals

- Build for WebAssembly ğŸ¯
- Execute untrusted code ğŸ”¦ğŸ”
- Package single-binary apps ğŸ§³

          </textarea></section><section data-markdown><textarea data-template>
            ### Artichoke ğŸ’â¤ï¸ğŸ¦€ Rust

          </textarea></section><section><section data-markdown><textarea data-template>
            #### WebAssembly Compilation

Build on WebAssembly targets with a  
native compiler toolchain ğŸ› 

          </textarea></section><section data-markdown><textarea data-template>
            #### Building WebAssembly

```shell
rustup add target wasm32-unknown-emscripten
cargo build --release --target wasm32-unknown-emscripten
```

          </textarea></section></section><section><h4>Deep Web Integration</h4><iframe class="playground" src="https://artichoke.run/?embed#%23%20frozen_string_literal%3A%20true%0A%0A%3C%3CUSAGE%0AThis%20program%20is%20a%20quine%20built%20using%0AArtichoke%20Ruby%20and%20a%20gem%20based%20on%20stdweb.%0AUSAGE%0A%0Arequire%20'uri'%0Arequire%20'artichoke%2Fweb'%0A%0Alocation%20%3D%20Artichoke%3A%3AWeb%3A%3AWindow.location%0Acontents%20%3D%20location.hash%5B1..-1%5D%0Aputs%20URI.decode(contents)"></iframe></section><section><section data-markdown><textarea data-template>
            #### Static Linking

Drop a single binary in `FROM scratch` Docker container and run a full Rails app
ğŸ’ğŸ³

          </textarea></section><section data-markdown><textarea data-template>
            #### Static Linking

Statically linked dependencies enable  
single binary app distributions ğŸ“»

          </textarea></section><section data-markdown><textarea data-template>
            #### Static Linking

Statically linked libc enables  
single binary app distributions ğŸ¥”

<hr style="width:50%">

`x86_64-unknown-linux-musl`

          </textarea></section></section><section data-markdown><textarea data-template>
            ### From Rust to Ruby

ğŸ¦€ â¡ï¸ ğŸ’

          </textarea></section><section data-markdown><textarea data-template>
            ### Ruby Core

```ruby
ENV['DRY_RUN'] = '0'
ary = Array.new(1024, 'Artichoke Ruby')
fixture = File.read(
  'artichoke-frontend/ruby/fixtures/learnxinyminutes.txt'
)
/function/.match(fixture)
```

          </textarea></section><section data-markdown><textarea data-template>
            ### Ruby Core

- Multiple implementations ğŸ˜ºğŸ˜¸ğŸ˜»
- Configurable at compile time ğŸ˜

          </textarea></section><section><section><h4>Untrusted <code>ENV</code> Access</h4><iframe class="playground" src="https://artichoke.run/?embed#%23%20frozen_string_literal%3A%20true%0A%0Aputs%20%22%23%7BENV.size%7D%20keys%20in%20%23%7BENV%7D%22%0Aputs%20%22ENV%20%3D%20%23%7BENV.to_h%7D%22%0A%0AENV%5B'CONFERENCE'%5D%20%3D%20'RubyConf'%0A%0Aputs%20%22ENV%20%3D%20%23%7BENV.to_h%7D%22"></iframe></section><section data-markdown><textarea data-template>
            #### `ENV`

- System backend â†”ï¸ OS ğŸ–¥
- In-memory backend â†”ï¸ `HashMap` ğŸŸ

          </textarea></section><section data-markdown><textarea data-template>
            #### In-Memory `ENV`

Build on WebAssembly targets that  
do not have a system environ ğŸ”§

          </textarea></section><section data-markdown><textarea data-template>
            #### In-Memory `ENV`

Run untrusted code by  
restricting system access â›“

          </textarea></section></section><section><section><h4>Capturable <code>IO</code></h4><iframe class="playground" src="https://artichoke.run/?embed#%23%20frozen_string_literal%3A%20true%0A%0Awarn%20%22That's%20no%20moon.%22%0A%0A(1..5).each%20do%20%7Cpilot%7C%0A%20%20print%20%22Red%20%23%7Bpilot%7D%20standing%20by%20...%22%2C%20%22%5Cn%22%0Aend%0A%0Aputs%20''%2C%20'Lock%20S-foils%20in%20attack%20position.'"></iframe></section><section data-markdown><textarea data-template>
            #### `IO`

- Capturable `$stdout` and `$stderr` ğŸ§¤
- Optional `IO#popen` ğŸšª
- Optional `Kernel#open("|date")` ğŸ“…

          </textarea></section><section data-markdown><textarea data-template>
            #### Capturable `IO`

Build on WebAssembly targets that  
do not have file descriptors ğŸ”§

          </textarea></section><section data-markdown><textarea data-template>
            #### Disabled `IO` pipes

Run untrusted code by disabling  
subprocess capabilities â›“

          </textarea></section></section><section><section><h4>Virtual <code>Kernel#require</code></h4><iframe class="playground" src="https://artichoke.run/?embed#%23%20frozen_string_literal%3A%20true%0A%0Arequire%20'json'%0A%0Ajson%20%3D%20%7B%20backend%3A%20'memory'%20%7D.to_json%0A%0Aputs%20json"></iframe></section><section data-markdown><textarea data-template>
            #### `File` Access

- System backend â†”ï¸ OS ğŸ—„ğŸ“
- In-memory backend â†”ï¸ `HashMap` ğŸ—ƒğŸ—‚

          </textarea></section></section><section><section><h4>Pure Rust <code>Regexp</code></h4><iframe class="playground" src="https://artichoke.run/?embed#%23%20frozen_string_literal%3A%20true%0A%0Ahaystack%20%3D%20%3C%3C-HAYSTACK%0A%20%20%5B%20ruby_koans%20%5D%20%24%20ruby%20path_to_enlightenment.rb%0A%20%20(in%20%2FUsers%2Fperson%2Fdev%2Fruby_koans)%0A%20%20cd%20koans%0A%0A%20%20Thinking%20AboutAsserts%0A%20%20test_assert_truth%20has%20damaged%20your%20karma.%0A%0A%20%20You%20have%20not%20yet%20reached%20enlightenment%20...%0A%20%20%3Cfalse%3E%20is%20not%20true.%0AHAYSTACK%0A%0Amatch%20%3D%20%2Fruby%20(%5Ba-zA-Z0-9_%5D%2B%5C.rb)%2F.match(haystack)%0A%0Aputs%20%22To%20walk%20the%20path%2C%20run%3A%22%2C%20%22%24%20ruby%20%23%7Bmatch%5B1%5D%7D%22"></iframe></section><section data-markdown><textarea data-template>
            #### `Regexp`

- Pure Rust engine for WebAssembly ğŸ’§
- Oniguruma engine for compatibility ğŸš—

          </textarea></section></section><section data-markdown><textarea data-template>
            ### From Core to Fast

ğŸğŸ’¨ ğŸğŸ

<small>Benchmarks run on AWS `c5.2xlarge` ğŸ–¥ ğŸ–¥</small>

          </textarea></section><section><section data-markdown><textarea data-template>
              ### `String#scan`

`String` pattern over 6.8MB of Unicode text ğŸ“š

```ruby
raise unless $fixture.scan('http://').length == 3539
raise unless $fixture.scan('https://').length == 1865
raise unless $fixture.scan('è¡¨è¾¾å¼').length == 120
raise unless $fixture.scan("\r\n").empty?
```

            </textarea></section><section><h3><code>String#scan</code></h3><iframe src="[object Module]" class="playground"></iframe></section></section><section><h3><code>String#scan</code></h3><div class="stat-container"><div class="stat-box stat-box-win"><div class="stat-box-type">Artichoke</div><div class="stat-box-number">66</div><div class="stat-box-units">ms / iteration</div></div><div class="divider"></div><div class="stat-box"><div class="stat-box-type">MRI</div><div class="stat-box-number">82</div><div class="stat-box-units">ms / iteration</div></div></div></section><section><section data-markdown><textarea data-template>
              ### `String#scan`

`Regexp` pattern over 6.8MB of Unicode text ğŸ“š

```ruby
raise unless $fixture.scan(%r{https?://}).length == 3539+1865
raise unless $fixture.scan(/è¡¨è¾¾å¼/).length == 120
raise unless $fixture.scan(/\r\n/).empty?
```

            </textarea></section><section><h3><code>String#scan</code></h3><iframe src="[object Module]" class="playground"></iframe></section></section><section><h3><code>String#scan</code></h3><div class="stat-container"><div class="stat-box stat-box-win"><div class="stat-box-type">Artichoke</div><div class="stat-box-number">48</div><div class="stat-box-units">ms / iteration</div></div><div class="divider"></div><div class="stat-box"><div class="stat-box-type">MRI</div><div class="stat-box-number">89</div><div class="stat-box-units">ms / iteration</div></div></div></section><section data-markdown><textarea data-template>
            ### Sparse Array Allocation

```ruby
a = []
a[1_000_000_000_000_000] = 'quadrillion'
a.concat((0..1000).to_a)

100.times do |i|
  a.unshift(i)
end

b = a.reverse
b[123_456_789, 500_000] = [Object.new, /Array/, 100.0]

puts a.length # => 1000000000001102
puts b.length # => 999999999501105
```

          </textarea></section><section><h3>Sparse Array Allocation</h3><div class="stat-container"><div class="stat-box stat-box-win"><div class="stat-box-type">Artichoke</div><div class="stat-box-number">7</div><div class="stat-box-units">MB / iteration</div></div><div class="divider"></div><div class="stat-box"><div class="stat-box-type">MRI</div><div class="stat-box-text">failed to allocate memory (<code>NoMemoryError</code>)</div><div class="stat-box-units"></div></div></div></section><section data-markdown><textarea data-template>
            ### Upcoming Core Work

- `Hash` with small vec backend ğŸ³
- `Range` and `Range`-based `Array` ğŸ¦‰
- `File` with in-memory and OS backends ğŸ§©

          </textarea></section><section><h3>Contributing</h3><p><a href="https://github.com/artichoke"><img class="github-logo" src="[object Module]" alt="GitHub"> github.com/artichoke</a></p><p><a href="https://artichoke.run">ğŸ¡ artichoke.run</a></p><p><a class="IssueLabel" style="background-color:#02e10c;color:#000" title="Call for participation: Experience needed to fix: Easy / not much." href="https://github.com/artichoke/artichoke/labels/E-easy">E-easy </a><a class="IssueLabel" style="background-color:#02e10c;color:#000" title="Call for participation: Help is requested to fix this issue." href="https://github.com/artichoke/artichoke/labels/E-help-wanted">E-help-wanted</a></p></section></div></div><div class="artichoke-chrome" style="display:none"><div class="header"><div class="header-tweet"><a href="https://twitter.com/intent/tweet?screen_name=artichokeruby&ref_src=twsrc%5Etfw" class="twitter-mention-button" data-size="large" data-show-count="false">Tweet to @artichokeruby</a></div><div></div><div class="header-logo"></div></div><div class="footer-logo"><a href="https://github.com/artichoke/artichoke" alt="Artichoke Ruby"><img src="https://www.artichokeruby.org/artichoke-logo.svg"></a></div></div><script src="/rubyconf/deck.2019.f9e71337231f2d5aaa1f.bundle.js"></script></body></html>